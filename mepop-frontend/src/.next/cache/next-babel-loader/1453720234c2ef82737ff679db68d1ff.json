{"ast":null,"code":"import { readString } from 'react-papaparse';\nimport axios from 'axios';\nimport { headers } from '../../assets/exampleBuyers';\nimport firebase from 'firebase';\nexport const getFileMethod = (auth, storage, resolve) => {\n  const UID = auth.currentUser.uid;\n  const storageRef = storage.ref(`${UID}`);\n  storageRef.listAll().then(({\n    items\n  }) => {\n    const getDownloadPromises = [];\n    items.forEach((fileRef, i) => {\n      // pushes promises to resolve synchronously\n      getDownloadPromises.push(fileRef.getDownloadURL());\n    });\n    const calls = []; // resolves getting the download URL's then pushes axios call to calls array\n\n    Promise.all(getDownloadPromises).then(responses => {\n      responses.forEach(url => {\n        calls.push(axios.get(url));\n      }); // resolves all calls in calls array and then sets up new state array for component\n\n      axios.all(calls).then(axios.spread((...responses) => {\n        const newData = [];\n        responses.forEach((res, j) => {\n          newData.push({\n            content: res.data,\n            filename: items[j].name\n          });\n        });\n        resolve(newData);\n      })).catch(err => {\n        resolve([]);\n        console.log(err);\n        window.alert('Error occurred while retreiving files. Try again');\n      });\n    }).catch(() => {\n      resolve();\n      console.error('Error Occurred');\n      window.alert('Error Occurred');\n    });\n  }).catch(() => {\n    resolve();\n    console.error('Error Occurred');\n    window.alert('Error Occurred');\n  });\n};\nexport const deleteFileMethod = (auth, storage, filename, fetchFiles) => {\n  const UID = auth.currentUser.uid;\n  const storageRef = storage.ref(`${UID}/${filename}`);\n  storageRef.delete().then(() => {\n    fetchFiles();\n  }).catch(err => {\n    console.log(err);\n    window.alert(err.message);\n  });\n};\nexport const uploadFilesMethod = (auth, storage, files, fetchFiles, err) => {\n  const rejectedFiles = []; // upload accepted files to firebase\n\n  const UID = auth.currentUser.uid;\n  let counter = 0;\n  files.forEach((file, i) => {\n    const fileReader = new FileReader();\n    fileReader.readAsText(file);\n\n    fileReader.onloadend = () => {\n      // converts CSV's data to string\n      if (readString(fileReader.result).errors.length) {\n        rejectedFiles.push(file.name);\n        counter++;\n      } else {\n        const rows = readString(fileReader.result).data;\n        counter++;\n\n        if (rows[0].length !== 22) {\n          // checks row length for length of 22\n          rejectedFiles.push(file.name);\n        } else if (JSON.stringify(rows[0]) !== JSON.stringify(headers)) {\n          // Compares Depop headers to first row of file\n          rejectedFiles.push(file.name);\n        } else {\n          // File passed all tests so it's upload time now...\n          const storageRef = storage.ref(`${UID}/${file.name}`);\n          const uploadTask = storageRef.put(file);\n          uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, snapshot => {\n            switch (snapshot.state) {\n              case firebase.storage.TaskState.PAUSED:\n                console.log('Upload is paused');\n                break;\n\n              case firebase.storage.TaskState.RUNNING:\n                // console.log('Upload is running')\n                break;\n            }\n          }, error => {\n            switch (error.code) {\n              case 'storage/unauthorized':\n                window.alert(\"You don't have permission to execute this action.\");\n                break;\n\n              case 'storage/canceled':\n                window.alert('Unknown Error. Operation canceled');\n                break;\n\n              case 'storage/unknown':\n                window.alert('Unknown Error');\n                break;\n            }\n          }, () => {\n            if (counter === files.length) {\n              fetchFiles();\n            }\n          });\n        }\n\n        if (i === files.length - 1) {\n          if (rejectedFiles.length) {\n            err(`The following files were not processed because they are not Depop files: ${rejectedFiles.join(', ')}. If this seems to be an error, please contact samote.wood@gmail.com for support.`);\n          }\n        }\n      }\n    };\n  });\n};","map":{"version":3,"sources":["/Users/samuelwood/development/mepop-firebase/packages/mepop-next/src/firebase/methods/files.js"],"names":["readString","axios","headers","firebase","getFileMethod","auth","storage","resolve","UID","currentUser","uid","storageRef","ref","listAll","then","items","getDownloadPromises","forEach","fileRef","i","push","getDownloadURL","calls","Promise","all","responses","url","get","spread","newData","res","j","content","data","filename","name","catch","err","console","log","window","alert","error","deleteFileMethod","fetchFiles","delete","message","uploadFilesMethod","files","rejectedFiles","counter","file","fileReader","FileReader","readAsText","onloadend","result","errors","length","rows","JSON","stringify","uploadTask","put","on","TaskEvent","STATE_CHANGED","snapshot","state","TaskState","PAUSED","RUNNING","code","join"],"mappings":"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","sourcesContent":["import { readString } from 'react-papaparse'\nimport axios from 'axios'\nimport { headers } from '../../assets/exampleBuyers'\nimport firebase from 'firebase'\n\nexport const getFileMethod = (auth, storage, resolve) => {\n  const UID = auth.currentUser.uid\n  const storageRef = storage.ref(`${UID}`)\n\n  storageRef.listAll().then(({ items }) => {\n    const getDownloadPromises = []\n    items.forEach((fileRef, i) => {\n      // pushes promises to resolve synchronously\n      getDownloadPromises.push(fileRef.getDownloadURL())\n    })\n\n    const calls = []\n    // resolves getting the download URL's then pushes axios call to calls array\n    Promise.all(getDownloadPromises).then((responses) => {\n      responses.forEach((url) => {\n        calls.push(axios.get(url))\n      })\n      // resolves all calls in calls array and then sets up new state array for component\n      axios.all(calls).then(axios.spread((...responses) => {\n        const newData = []\n        responses.forEach((res, j) => {\n          newData.push({ content: res.data, filename: items[j].name })\n        })\n        resolve(newData)\n      }))\n        .catch((err) => {\n          resolve([])\n          console.log(err)\n          window.alert('Error occurred while retreiving files. Try again')\n        })\n    })\n      .catch(() => {\n        resolve()\n        console.error('Error Occurred')\n        window.alert('Error Occurred')\n      })\n  })\n    .catch(() => {\n      resolve()\n      console.error('Error Occurred')\n      window.alert('Error Occurred')\n    })\n}\n\nexport const deleteFileMethod = (auth, storage, filename, fetchFiles) => {\n  const UID = auth.currentUser.uid\n  const storageRef = storage.ref(`${UID}/${filename}`)\n\n  storageRef.delete().then(() => {\n    fetchFiles()\n  }).catch((err) => {\n    console.log(err)\n    window.alert(err.message)\n  })\n}\n\nexport const uploadFilesMethod = (auth, storage, files, fetchFiles, err) => {\n  const rejectedFiles = []\n\n  // upload accepted files to firebase\n  const UID = auth.currentUser.uid\n  let counter = 0\n  files.forEach((file, i) => {\n    const fileReader = new FileReader()\n    fileReader.readAsText(file)\n\n    fileReader.onloadend = () => {\n      // converts CSV's data to string\n      if (readString(fileReader.result).errors.length) {\n        rejectedFiles.push(file.name)\n        counter++\n      } else {\n        const rows = readString(fileReader.result).data\n        counter++\n\n        if (rows[0].length !== 22) {\n          // checks row length for length of 22\n          rejectedFiles.push(file.name)\n        } else if (JSON.stringify(rows[0]) !== JSON.stringify(headers)) {\n          // Compares Depop headers to first row of file\n          rejectedFiles.push(file.name)\n        } else {\n          // File passed all tests so it's upload time now...\n          const storageRef = storage.ref(`${UID}/${file.name}`)\n          const uploadTask = storageRef.put(file)\n\n          uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED,\n            (snapshot) => {\n              switch (snapshot.state) {\n                case firebase.storage.TaskState.PAUSED:\n                  console.log('Upload is paused')\n                  break\n                case firebase.storage.TaskState.RUNNING:\n                  // console.log('Upload is running')\n                  break\n              }\n            }, (error) => {\n              switch (error.code) {\n                case 'storage/unauthorized':\n                  window.alert(\"You don't have permission to execute this action.\")\n                  break\n                case 'storage/canceled':\n                  window.alert('Unknown Error. Operation canceled')\n                  break\n                case 'storage/unknown':\n                  window.alert('Unknown Error')\n                  break\n              }\n            }, () => {\n              if (counter === files.length) {\n                fetchFiles()\n              }\n            })\n        }\n        if (i === files.length - 1) {\n          if (rejectedFiles.length) {\n            err(`The following files were not processed because they are not Depop files: ${rejectedFiles.join(', ')}. If this seems to be an error, please contact samote.wood@gmail.com for support.`)\n          }\n        }\n      }\n    }\n  })\n}\n"]},"metadata":{},"sourceType":"module"}